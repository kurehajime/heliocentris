# 連絡帳

人間に確認OKをもらえたら作業内容を3行程度にまとめて日付付きでここに記載してください

## 2025-11-12
- フェイズ1（Vite + React + TypeScript の Hello World 環境構築）を手動で完了。
- これで次フェイズの型設計・ドキュメント整理に着手できる状態。
- 追加作業や確認事項があれば指示をお願いします。

## 2025-11-13 (フェイズ2画面仮実装)
- GameState/Field/Mino系の型とGameManagerクラスの雛形を作成し、状態遷移と初期化の入口を整備。
- GameElement/FieldElement/BlockElementを追加してSVGグリッドに固定＋落下フィールドを合成描画、Next表示と仮tickボタンを配置。
- Appをゲーム画面用に刷新し、レイアウト/配色を専用CSSで調整。`npm run build`でビルド成功を確認。

## 2025-11-13 (フェイズ2 SVGレイアウト)
- GameElement全体を単一SVG化し、フィールド＋ネクスト欄を正方形ビュー内で描画するようFieldElement/Sidebarを再構成。
- Appをゲーム画面のみの表示にし、CSSでコンテナ自体を正方形に固定してタイトル/説明テキストを撤去。
- SVG内でのネクスト表示や状態更新ボタンも描画し直し、`npm run build`で正常ビルドを確認。

## 2025-11-13 (中央配置＋角丸撤廃)
- root/appのflexを調整し、GameElementの実サイズを`min(90vmin, 640px)`に固定して画面中央へ寄せた。
- FieldElement/BlockElement/Sidebar内矩形から角丸指定を除去し、SVG/背景矩形もフラット形状に統一。
- `npm run build`で通ることを確認済み。

## 2025-11-13 (グリッド＋選択抑止)
- FieldElementへグリッドライン描画を追加し、薄い補助線でマス目を視認できるようにした。
- body/ゲームSVGに`user-select: none`を設定し、NEXTなどのテキストが選択されないよう制御。
- `npm run build`でビルドOK。

## 2025-11-13 (フェイズ3デモブロック)
- GameManager初期化時に底部中央へ2x2の固定ブロックを埋め込み、フェイズ3要件のグリッド表示を準備。
- セルのコピーを確保してデモ用ブロックを塗り分け、今後の描画・ロジックに影響しないよう分離。
- `npm run build`で動作確認済み。

## 2025-11-13 (フェイズ4計画更新)
- 開発計画にフェイズ4の詳細ステップ(ドラッグ検出/セル換算/地面オフセット/描画補正/ループ準備)を追加してタスクを明確化。
- まずセル単位移動→後でピクセル単位に拡張する流れを文書化して、実装順序を共有。
- 引き続きフェイズ4実装に着手できる状態。

## 2025-11-13 (フェイズ4計画微修正)
- groundOffset等のオフセット処理は後工程で扱う方針に修正し、フェイズ4ではセル単位のFixedField組み替えまでに範囲を限定。
- 計画ドキュメントを更新し、まずはドラッグ→セル再配置→(後でオフセット)という優先順位を明記。
- 実装タスクの見通しが揃ったため、この方針でフェイズ4作業を継続予定。

## 2025-11-13 (フェイズ4 セル移動実装)
- GameStateに`groundShift`を追加し、GameManagerで列入れ替えによる地面シフトを扱える`shiftGroundByCells`を実装。
- SVG上でpointerドラッグを受け取り、移動距離(px)→セル数へ換算して随時`shiftGroundByCells`を適用。セル単位で即時に地面が移動する。
- `npm run build`で動作確認済み。今後はピクセル単位のオフセットやループ表示に発展予定。

## 2025-11-13 (フェイズ5方針変更)
- ピクセル単位の表示/操作は見送る方針に切り替え、フェイズ5はセル単位挙動の安定化とループ表示の実装を主軸とするよう計画を整理。
- 追加のコード変更は不要だったため、ドキュメントのみ確認。
- 今後はドラッグ安定化・スナップ調整・ダミー列描画に集中予定。

## 2025-11-13 (ダミー列撤回)
- オフセット実装を取りやめたことに合わせ、描画用ダミー列も不要と判断して開発計画を更新。
- フェイズ4のTODOに「ダミー列なし」方針を追記し、セル単位の挙動改善に専念できるよう整理。
- コード変更はなく、ドキュメント調整のみ。

## 2025-11-13 (フェイズ5 落下処理)
- GameStateに`activeMino`を追加し、GameManagerでNextキューからミノを生成→中央へスポーン→tickごとに1行落下→着地で固定する流れを実装。
- 固定時はFixedFieldへセルを焼き付け、FallingFieldは`activeMino`から都度再構成されるため描画が同期。
- `npm run build`でビルド完了。落下中のブロックは地面シフトの影響を受けず中央に落ち続ける。

## 2025-11-13 (ゲームループ導入)
- GameElement内で`requestAnimationFrame`ループを構築し、800msごとに自動で`GameManager.tick`を呼び出して落下を進行。
- ループ開始/停止処理をuseEffectで管理し、従来のボタン手動tickも併用可能な構成にした。
- `npm run build`で正常動作を確認。

## 2025-11-13 (フェイズ6 押し出し)
- 地面シフト時に落下ブロックと固定ブロックが重なった場合、ドラッグ方向へ1セルずつ押し出すロジックを`GameManager.shiftGroundByCells`に追加。
- 最初に衝突していないか判定し、必要な分だけ横移動させてからFallingFieldを再構築することで描画と同期。
- `npm run build`でビルドOK。

## 2025-11-13 (すり抜け簡易対策)
- 地面移動を必ず1セルずつ処理するよう`shiftGroundByCells`を改修し、各ステップで押し出し可否を判定。
- 押し出し不能な場合はその時点で移動を止め、固定ブロックが落下ミノを貫通しないようにした。
- `npm run build`で正常動作を確認。

## 2025-11-13 (フェイズ7 ゴースト)
- CellStateにGhostを追加し、BlockElementで半透明表示を設定。
- GameManagerが落下ミノの着地見込み位置を計算してGhostを描画するように`composeFallingField`を拡張。
- `npm run build`でビルドOK。

## 2025-11-13 (フェイズ8 手動落下)
- PointerドラッグのY移動量を計測し、Xより大きくかつ下方向ならグリッド換算で即時落下するようGameElementを改修。
- GameManagerに`dropActiveMino`を追加し、ゴースト位置までの範囲で安全にActiveミノを下げるAPIを用意。
- `npm run build`で正常動作を確認。

## 2025-11-13 (フェイズ9 ライン消去)
- GameStateに`clearingRows`と`clearCountdown`を追加し、満タン行をDeleting→一定tick後にEmptyへ変化させる仕組みを実装。
- Tick開始時に消去中かどうか判定、カウント完了で行をクリアしてから次のミノをスポーンする流れを構築。
- `npm run build`でビルドOK。

## 2025-11-13 (ライン消去チューニング)
- Deleting状態の持続を2tickに短縮し、消滅後は空行を上部に追加してフィールド全体を下へ詰める処理を実装。
- `compactAfterClearing`で削除対象行を除いた残りの行を上から詰め、自動的に落下感を演出。
- `npm run build`で正常動作を確認。

## 2025-11-13 (ライン演出強化)
- Deleting状態の持続を1tickに短縮し、消えた行がさらに素早く処理されるよう調整。
- 消去予定セルの色を白(#fff)で塗り、BlockElementで不透明表示することで光る演出に変更。
- `npm run build`でビルド成功。

## 2025-11-13 (フェイズ10 回転初期化)
- ActiveMinoに`rotation`を追加し、スポーン時に0/90/180/270度のいずれかをランダムで付与。
- すべての当たり判定・描画・合成処理を回転形状に対応させ、回転状態でもゴーストや押し出しが成立するよう調整。
- `npm run build`でビルドOK。

## 2025-11-13 (フェイズ11 ミノ選択AI)
- 7-bagから候補ミノを取り出し、各回転・落下位置での評価値(ライン消去/穴/凹凸/高さ)を計算して最良ミノを選ぶアルゴリズムを追加。
- 選ばれたミノは最適回転でスポーンし、bagからは該当ミノを除去して不足分は新バッグで補充。
- `npm run build`でビルド成功。

## 2025-11-13 (評価ロジック分離)
- 評価関数や盤面スコアリング処理を`src/game/lib/evaluation.ts`に切り出し、GameManagerの責務を軽量化。
- これに伴いクローン/配置判定ヘルパーも共通化し、GameManagerは評価ライブラリを呼び出すだけの構造に整理。
- `npm run build`で正常完了。

## 2025-11-13 (Tミノ定義修正)
- `MINO_MAP`のT定義が下段左寄りになっていたため、中央下セルに修正し正しいT字形状になるよう再定義。
- 修正後に`npm run build`で問題ないことを確認。

## 2025-11-13 (井戸ボーナス実装)
- 評価ロジックにwellBonusを追加し、幅1セルの開いた縦穴で底が他列で埋まっている場合に加点するように調整。
- `src/game/lib/evaluation.ts`で井戸深さと底行の充足を判定し、ライン消去の潜在性を評価値に反映。
- `npm run build`で正常完了。

## 2025-11-13 (評価モード切替)
- 盤面状況によって評価重みを変更し、穴あり/高積み時はwellBonusを0にして消去優先、穴無し・低積み時はライン加点を0にして積み重ね優先に切り替える処理を追加。
- `src/game/lib/evaluation.ts`で最大高さ・穴数を計測し、configを動的に調整。
- `npm run build`でビルド成功。

## 2025-11-13 (フェイズ12 UI簡素化)
- GameElementからNEXT一覧と状態更新ボタンを撤去し、FieldElementのみを中央に配置するレイアウトへ刷新。
- SVGビューの計算をフィールドサイズ基準に変更し、App全体のCSSもシンプルな正方形表示に寄せた。
- `npm run build`でレイアウト変更後のビルドOK。

## 2025-11-15
- .agents配下の主要ドキュメント（ゲーム概要/ゲームループ/構成技術/落下ミノ選択アルゴリズム/開発計画）を読んで要点を整理。
- README.mdも確認してリポジトリ全体の表題を把握。
- 今後の実装・質疑に備えて参照ポイントを共有できる状態にした。

## 2025-11-15 (スマホ余白調整)
- GameElementのviewBoxを縦長比率に変更し、左右2セル分の余白のみ確保するレイアウトへ更新。
- SVGのaspect-ratioを動的指定しつつ、CSSで幅を`vw`基準に再設定してスマホでの拡大率を改善。
- `npm run build`でビルドが通ることを確認。

## 2025-11-15 (SVGスクロール抑止)
- `.game-element`に`touch-action: none`を追加し、SVG上のドラッグ操作が画面スクロールへ伝播しないように調整。
- これにより縦ドラッグによるソフトドロップ操作中でもブラウザがスクロールしない。
- `npm run build`でCSS反映後も問題なくビルド完了。

## 2025-11-15 (フィールド位置調整)
- GameElementのレイアウト計算で`fieldY`を1セル分引き、フィールド全体を上方へシフトさせて下部の余白を広げた。
- `Math.max`でマイナスにならないよう抑制しつつ、上下バランスを取り直したためスマホ縦表示でも下部UIスペースを確保。
- `npm run build`でビルド通過を確認。

## 2025-11-15 (フェイズ13 ゲームオーバー)
- GameStateに`gameOver`を追加し、最上段へ固定ブロックが到達した時点/スポーン不能時にゲームオーバーへ遷移する処理をGameManagerへ実装。
- FieldElementで最上段の背景を赤系に塗り、GameElementにはニューゲームボタン付きオーバレイを表示して操作を停止。
- `.game-element`をラッパー化してボタンUI/CSSを追加し、`npm run build`でフェイズ13実装後もビルド成功を確認。

## 2025-11-15 (スポーン位置調整)
- `canPlaceShape`で盤面外（負の行）を許容し、ミノが上部で一時的に隠れた状態でも配置できるように変更。
- `spawnActiveMino`の初期rowをミノ高さ分だけマイナスにして、実際に最上段へ達するまでゲームオーバーにならない挙動に修正。
- `npm run build`で問題なく完了。
