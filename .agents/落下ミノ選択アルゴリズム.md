# 落下ミノ選択アルゴリズム（フェイズ10+）

## 基本方針

- 7-bagは維持して、バランス良くミノが回るようにする。
- 予約（Hold）機能は廃止し、常に「次に降るミノ」はその場で決定する。
- 決定ロジックは `評価値` に基づく。バッグに入っている各ミノについて、取り得る回転（0/90/180/270°）ごとに「その向きで盤面に落とした場合の潜在的スコア」を見積もり、最も良いスコアを出せそうなミノを次に選ぶ。
- ミノ選択は本質的に貪欲法。ただしバッグ内の候補はすべて評価対象にすることで、毎回違う形でも状況に応じて最適なミノを優先できる。

## スコアリングの考え方（例）

- `linesClearedScore`: 一手で消せるライン数をもとにポイントを加算（例: 行数^2）。
- `holesPenalty`: 新たに生まれる穴（上にブロックがある空セル）1つにつき大きく減点。
- `surfacePenalty`: 列ごとの高さ差を計算し、総和を減点。滑らかな表面になる操作を好む。
- `wellBonus`: 幅1セルの縦穴で、上に蓋が無く、穴から底までの行が「その列以外の9セルすべて埋まっている」場合に深さに応じて加点。Iミノを差し込めば消去できる“開いた井戸”を評価する。
- これらを合算して `score = linesClearedScore + wellBonus - holesPenalty - surfacePenalty ...` という形で扱う。
- ただしそれぞれの要素には重み付けを行い、調整可能にする。
- 状況に応じて評価モードを切り替えたい。
   消去モード
   * 穴(上にブロックがある空セル)が存在する or 最も高いブロックが11以上
   * wellBonusの重みを0にする

   積み上げモード
   * 穴(上にブロックがある空セル)が存在しない and 最も高いブロックが10以下
   * linesClearedScoreの重みを0にする

- 評価中はドラッグによる地面移動・手動落下等も適用済みの状態で考える。（実際のゲームでは、予め地面を動かしてミノを受け止める前提になる）

## 手順

1. **バッグ維持**
   - 7種類（I,O,T,S,Z,J,L）のセットをシャッフルしてbagにする。
   - bagが空になったら再シャッフルで補充。

2. **候補生成**
   - 現在のbagから順にミノを取り出し、各ミノについて回転0/90/180/270°を列挙。
   - 回転結果の形状が等価な場合（例: Oミノ、180°と0°が同じなど）は重複を取り除いてもよい。

3. **評価**
- 各ミノ×回転x落下位置の組み合わせについて、仮想的に落とし込んだ場合の盤面をシミュレーション。
- スコア関数により数値化し、最大値を取る組を記録。

4. **ミノ決定**
   - 最良スコアを出した組のミノをbagから取り、実際にスポーン。
   - 同点が複数ある場合は、bag順で決める。

5. **ゲーム進行**
   - 選ばれたミノは従来通りの地面ドラッグ＋落下ルールで処理。
   - 次tickで再びbag内の候補を評価して選ぶ。

## 実装メモ

- 評価用シミュレーションは `GameManager` 相当の純粋関数で行い、実際の状態に副作用を与えない。
- 実機での負荷を避けるため、評価の深さは1手分（即時結果のみ）とする再計算。
- この計算は次の落下ミノが必要になるときにのみ実行する。
