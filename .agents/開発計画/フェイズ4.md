# フェイズ4: ゲーム成立に向けた詳細ステップ

## ゴール
- 地面ドラッグと落下ミノ挙動を接続し、「地面が動くテトリス」として最低限プレイできる状態を作る。
- 行消去・スコア加算・Nextキュー更新が一通り回る。
- 操作レスポンスと描画が安定し、バグ調査やチューニングができる土台を作る。

## 手順（優先順）

1. **GameState拡張**
   - FallingMinoState を実際に生成・更新する。
   - FixedField/FallingField を描画用にマージする仕組みを整備。
   - GroundState とミノの水平方向同期（地面の移動量で落下ミノが押し出されるロジック）を実装。

2. **Queue/初期生成**
   - 7bag の NextMinoQueue 補充を GameManager に実装。
   - 開始時・ライン消去後のミノ生成ロジックを追加。

3. **落下・衝突・設置サイクル**
   - requestAnimationFrame tick 内で一定間隔ごとに `anchor.y` を進める。
   - 衝突判定（壁・地面・固定ブロック）と Fixing/FIxed 状態遷移、FixDelay 管理を追加。
   - Fix後に行消去チェックへ移行し、Deleting→Empty のステート更新を行う。

4. **入力統合**
   - SVG 全体のドラッグ入力から `GroundDragCommand` を生成し、GameManager 内で反映。
   - 将来的なミノ押し・タップ操作を見越して InputState を拡張できる構造に保つ。
   - ポーズやリセットを Overlay 内ボタンから呼べるようフェーズ遷移を整理。

5. **ライン消去とスコアリング**
   - LineClearEvent を使ってエフェクト時間を管理。
   - 消去行数に応じて Stats（score, clearedLines, level）を更新。
   - Level に応じて GameConfig（gravity/fixDelay）を再計算し、ゲームスピードを段階的に上げる。

6. **描画・デバッグ補助**
   - ゴースト表示、Fixing/Deleting のアニメーション透過度、地面無限スクロールなど描画を詰める。
   - デバッグ用に `StatsPanel` に tick/queue/ground offset などの簡易情報を追加（必要に応じて）。
   - バウンディングテスト（行が10+になる、長時間プレイ）を行い、クラッシュ箇所を修正。

7. **最終チェック**
   - npm run build / npm run dev で手動プレイ確認。
   - 主要シナリオ（開幕→Fix→ライン消去→レベルアップ→ゲームオーバー）を一通り試す。
   - 完了報告を `.agents/連絡帳.md` に追記し、フェイズ5への改善点をメモ。

フェイズ4は「遊べる状態」を作るタームのため、問題が見つかった場合は上記ステップを柔軟に往復して品質を上げる。
