# 構成技術

- React
- Vite
- TypeScript



## 画面描画
ReactでSVGを組み立ててゲーム画面を構築する。
./sample/iroawaseのコードを参考にする。


## type設計

基本的には `type` を使ってデータを記述する。ゲームを成立させるために最低限必要な型を以下に列挙する。

### コア値オブジェクト
- **CellState**: `'Empty' | 'Ghost' | 'Falling' | 'Fixing' | 'Fixed' | 'Deleting'`。描画とロジックの両方で使う状態列挙。
- **CellColor**: `'ground' | 'ghost' | 'mino-I' | ...` のような色名文字列。ミノ種別に応じたテーマカラーを管理する。
- **Cell**: `{ color: CellColor; state: CellState }`。フィールド1マスの完全な情報。
- **FieldSize**: `{ width: number; height: number }`。基準フィールドのマス数。
- **FieldCoordinate**: `{ x: number; y: number }`。ミノのアンカーなど整数マス単位の座標。
- **PixelOffset**: `{ x: number; y: number }`。地面・落下ミノのサブピクセル移動量。

### フィールド/ミノ関連
- **FixedField**: `Cell[][]`。設置済みブロック。左右ループ用のダミー列を含む。
- **FallingField**: `Cell[][]`。現在落下中のミノを描画するための一時フィールド。
- **MinoType**: `I | O | T | S | Z | J | L`。
- **MinoRotation**: `0 | 90 | 180 | 270`。
- **MinoMap**: `Record<MinoType, Cell[][]>`。各回転状態のセル配置を持つ。
- **FallingMinoState**: `{ type: MinoType; rotation: MinoRotation; anchor: FieldCoordinate; offsetPx: PixelOffset; cells: Cell[][] }`。
- **GroundState**: `{ offsetPx: number; direction: 'left' | 'right' | 'still'; speedPxPerSec: number }`。地面の滑り量と速度。
- **LineClearEvent**: `{ rows: number[]; startedAt: number }`。Deleting状態の管理に使う。

### ゲーム進行
- **GamePhase**: `'ready' | 'playing' | 'gameover' | 'pause'`。
- **GameConfig**: `{ gravityMs: number; fixDelayMs: number; deleteDelayMs: number; fieldSize: FieldSize }`。難易度ごとに差し替える。
- **NextMinoQueue**: `MinoType[]`。7bagなどの供給ロジックで満たす。
- **GameStats**: `{ score: number; clearedLines: number; level: number }`。
- **GameState**: `{ phase: GamePhase; fixedField: FixedField; falling: FallingMinoState | null; fallingField: FallingField; ground: GroundState; queue: NextMinoQueue; stats: GameStats; activeClear: LineClearEvent | null; lastTick: number }` のようにゲーム全体を表す。

### 入力・ループ
- **PointerDrag**: `{ startPx: number; currentPx: number }`。地面を横方向にドラッグした距離だけを保持する（セル座標は不要）。
- **GroundDragCommand**: `{ deltaPx: number }`。指を離した瞬間に生成される地面シフト命令。`deltaPx` を固定幅単位に丸めて `GameManager` が処理する。
- **InputState**: `{ groundDrag: PointerDrag | null; lastCommand: GroundDragCommand | null; isDragging: boolean }`。tickのたびに `GameManager` へ渡す最小限の情報。
- **TickContext**: `{ now: number; deltaMs: number; inputs: InputState }`。`requestAnimationFrame` から得た情報をGameManagerに渡す。
- **RenderState**: `{ game: GameState; viewportPx: { width: number; height: number } }`。React側に渡す描画用構造体。

## class

`〜Manager` のようなクラスは、静的メソッドのみで新しい状態を返す。そのため、内部状態を直接 mutate しない。GameManager が Field/Queue/Speed の責務をひとまとめに持ち、時間の計測とピクセル単位の座標制御（地面・ポインタ）は専用の仕組みに任せる。

- **GameManager**: `create(config)`, `tick(prevState, tickContext)`, `applyInput(state, inputState)` を持ち、フィールド処理（衝突判定・行消去・`FixedField`合成）、NextMinoQueue生成/補充、レベル進行に応じた `GameConfig` 更新まで含めて統括する。
- **GroundManager**: 地面のピクセルオフセットやラップ位置を計算し、GameManagerに渡せる形へ正規化する（ピクセル単位の座標だけを担当）。
- **InputManager**: Pointerイベントから `PointerDrag` を更新し、指を離した瞬間に `GroundDragCommand` を生成して `InputState` へ格納するだけのシンプルな役割（ピクセル座標の扱いはここに閉じ込める）。

## コンポーネント

Reactコンポーネントは `GameElement` が状態管理をまとめ、配下は純粋関数コンポーネントとする。

- **GameElement**: 直接 `requestAnimationFrame` ループを制御し、`GameState` を保持して全UIを束ねる。
- **FieldElement**: 固定フィールド＋落下中フィールド＋ループ用ダミー列をSVGで描画する。
- **BlockElement**: 1マス分の矩形/グラデーションを描画。`CellState` に応じてアニメーションを切り替える。
- **GroundElement**: 地面のピクセルオフセットを受け取り、足場の移動アニメーションを表示する。
- **QueueElement**: `NextMinoQueue` を縦積みで可視化。先頭要素を強調。
- **StatsPanelElement**: スコア・ライン数・レベルなど `GameStats` を表示。
- **ControlHintElement**: 入力方法やポーズ状態を表示。フェイズ3以降のUI整備にも流用する。
- **OverlayElement**: フェーズ（開始待ち・ポーズ・ゲームオーバー）に応じてメッセージやボタンを重ねる。

これらの型/クラス/コンポーネントを満たすように、フェイズ3で仮実装を進める。
